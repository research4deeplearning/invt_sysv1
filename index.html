<!DOCTYPE html>
<html>
<head>
    <title>Smart Inventory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Mobile & Layout Tweaks */
        body { padding-bottom: 80px; background-color: #f8f9fa; }
        .hidden { display: none !important; }

        /* Sticky Navigation */
        .navbar { position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Table Styling */
        .table-img { width: 45px; height: 45px; object-fit: cover; border-radius: 6px; }
        .table-responsive { max-height: 65vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* Badge Colors */
        .badge-in { background-color: #d1e7dd; color: #0f5132; } /* Greenish */
        .badge-out { background-color: #f8d7da; color: #842029; } /* Reddish */

        /* Loader */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark bg-dark mb-3">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">ðŸ“¦ Inventory</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link active" onclick="switchTab('inventory')">Stock</a>
            <a class="nav-link" onclick="switchTab('sales')">Sell</a>
            <a class="nav-link" onclick="switchTab('history')">History</a> <a class="nav-link" onclick="switchTab('analytics')">Stats</a>
        </div>
    </div>
</nav>

<div class="container">

    <div id="tab-inventory">
        <div class="card p-3 mb-3 border-0 shadow-sm">
            <h5 class="mb-3 text-primary">âž• Add Stock</h5>
            <form id="form-add">
                <div class="row g-2">
                    <div class="col-12">
                        <input type="text" id="in-name" class="form-control" placeholder="Item Name" required>
                    </div>
                    <div class="col-6">
                        <select id="in-unit" class="form-select">
                            <option value="pcs">Pieces</option>
                            <option value="kg">Kg</option>
                            <option value="L">Liters</option>
                            <option value="m">Meters</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <input type="number" id="in-price" class="form-control" placeholder="Cost Price" inputmode="decimal" required>
                    </div>
                    <div class="col-12">
                        <div class="input-group">
                            <input type="number" id="in-qty" class="form-control" placeholder="Qty" inputmode="decimal" step="0.01" required>
                            <input type="file" id="in-file" class="form-control" accept="image/*">
                        </div>
                    </div>
                    <div class="col-12 mt-2">
                        <button type="submit" class="btn btn-primary w-100 fw-bold">Add to Stock</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="card p-3 border-0 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">ðŸ“¦ Current Stock</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadData()">â†» Refresh</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead class="table-light sticky-top">
                        <tr><th>Img</th><th>Item</th><th>Qty</th><th>Unit</th></tr>
                    </thead>
                    <tbody id="inventory-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-sales" class="hidden">
        <div class="card p-4 mx-auto border-0 shadow-sm" style="max-width: 600px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0 text-success">ðŸ’° Record Sale</h4>
                <img id="sell-thumb-preview" src="" class="hidden"
                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; border: 3px solid #198754;">
            </div>

            <form id="form-sell">
                <div class="mb-3">
                    <label class="form-label fw-bold">Select Item</label>
                    <select id="sell-name" class="form-select form-select-lg" onchange="updateSellThumbnail()" required>
                        <option value="">-- Choose Item --</option>
                    </select>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="small text-muted">Qty Sold</label>
                        <input type="number" id="sell-qty" class="form-control form-control-lg" step="0.01" inputmode="decimal" required>
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">Price (Per Unit)</label>
                        <input type="number" id="sell-price" class="form-control form-control-lg" inputmode="decimal" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="small text-muted">Date</label>
                    <input type="date" id="sell-date" class="form-control">
                </div>
                <button type="submit" class="btn btn-success w-100 btn-lg py-3 fw-bold">Confirm Sale</button>
            </form>
        </div>
    </div>

    <div id="tab-history" class="hidden">
        <div class="card p-3 border-0 shadow-sm">
            <h5 class="mb-3 text-secondary">ðŸ“œ Transaction Log</h5>

            <div class="row g-2 mb-3">
                <div class="col-5"><input type="date" id="hist-start" class="form-control form-control-sm"></div>
                <div class="col-5"><input type="date" id="hist-end" class="form-control form-control-sm"></div>
                <div class="col-2"><button onclick="loadHistory()" class="btn btn-sm btn-dark w-100">Go</button></div>
            </div>

            <div class="table-responsive">
                <table class="table table-sm align-middle" style="font-size: 0.9rem;">
                    <thead class="table-light">
                        <tr><th>Date</th><th>Item</th><th>Type</th><th>Qty</th><th>Rate</th></tr>
                    </thead>
                    <tbody id="history-list">
                        <tr><td colspan="5" class="text-center text-muted">Select dates and click Go</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-analytics" class="hidden">
        <div class="card p-3 border-0 shadow-sm">
            <h4>ðŸ“Š Analysis</h4>

            <p class="text-muted small mb-3">
                Report from: <span id="report-range-start" class="fw-bold">...</span>
                to <span id="report-range-end" class="fw-bold">...</span>
            </p>

            <div class="row g-2 mb-3">
                <div class="col-6"><input type="date" id="an-start" class="form-control text-small"></div>
                <div class="col-6"><input type="date" id="an-end" class="form-control text-small"></div>
                <div class="col-12">
                    <select id="an-item" class="form-select">
                        <option value="ALL">All Items</option>
                    </select>
                </div>
                <div class="col-12">
                    <button onclick="runAnalytics()" class="btn btn-dark w-100">Analyze</button>
                </div>
            </div>

            <div class="row text-center g-2">
                <div class="col-6">
                    <div class="p-3 border rounded bg-white">
                        <small class="text-muted d-block">Acquired Cost</small>
                        <h4 class="text-danger mb-0" id="res-expense">â‚¹ 0</h4>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-3 border rounded bg-white">
                        <small class="text-muted d-block">Sold Revenue</small>
                        <h4 class="text-success mb-0" id="res-income">â‚¹ 0</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="loader" class="loading-overlay">
    <div class="spinner-border text-primary mb-2" role="status"></div>
    <span>Processing...</span>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyjeeobmdl1FC4BFoXVcBcDVZNmSQKrszquhDu1EcHMozisbGw5s7wzsOIfZhHUAcmK/exec'; // <--- PASTE NEW URL HERE
    let AUTH_CODE = '';
    let INVENTORY_DATA = [];

    // --- INITIALIZATION ---
    window.onload = async () => {
        AUTH_CODE = localStorage.getItem('inv_auth');
        if(!AUTH_CODE) {
            AUTH_CODE = prompt("Enter System Password:");
            if(AUTH_CODE) localStorage.setItem('inv_auth', AUTH_CODE);
        }

        // Set Defaults
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

        // Set all date inputs
        const dateStr = d => d.toISOString().split('T')[0];

        document.getElementById('sell-date').value = dateStr(today);
        document.getElementById('an-start').value = dateStr(firstDay);
        document.getElementById('an-end').value = dateStr(today);
        document.getElementById('hist-start').value = dateStr(firstDay);
        document.getElementById('hist-end').value = dateStr(today);

        // Load Initial Data
        await loadData();
        // Initial run of analytics just to populate the text
        updateDateHeader();
    };

    // --- NAVIGATION ---
    function switchTab(tabId) {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        event.target.classList.add('active');

        ['inventory', 'sales', 'history', 'analytics'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
        document.getElementById(`tab-${tabId}`).classList.remove('hidden');

        if(tabId === 'sales') populateDropdowns();
    }

    // --- API & DATA HANDLING ---
    async function loadData() {
        showLoading(true);
        try {
            const res = await fetch(`${API_URL}?authi=${AUTH_CODE}`);
            const data = await res.json();
            if(data.error) throw new Error(data.error);
            INVENTORY_DATA = data;
            renderInventoryTable(data);
        } catch (e) {
            if(confirm("Error loading. Reset login?")) {
                localStorage.removeItem('inv_auth');
                location.reload();
            }
        }
        showLoading(false);
    }

    // --- 1. STOCK TABLE RENDER (Updated Columns) ---
    function renderInventoryTable(data) {
        const tbody = document.getElementById('inventory-list');
        tbody.innerHTML = '';
        data.forEach(item => {
            let imgUrl = fixDriveLink(item.image);
            const imgHtml = imgUrl
                ? `<img src="${imgUrl}" class="table-img" referrerpolicy="no-referrer">`
                : `<div class="bg-secondary rounded text-white d-flex align-items-center justify-content-center table-img" style="font-size:10px;">N/A</div>`;

            tbody.innerHTML += `
                <tr>
                    <td style="width: 50px;">${imgHtml}</td>
                    <td class="fw-bold text-dark">${item.name}</td>
                    <td><span class="badge bg-primary rounded-pill">${item.qty}</span></td>
                    <td class="text-muted small">${item.unit}</td>
                </tr>`;
        });
    }

    // --- 2. SALES LOGIC (Updated Dropdown Format) ---
    function populateDropdowns() {
        const sellSelect = document.getElementById('sell-name');
        const anSelect = document.getElementById('an-item');
        const currentSell = sellSelect.value;

        sellSelect.innerHTML = '<option value="">-- Choose Item --</option>';
        anSelect.innerHTML = '<option value="ALL">All Items</option>';

        INVENTORY_DATA.forEach(item => {
            // New Format: Name (Qty Unit)
            sellSelect.innerHTML += `<option value="${item.name}">${item.name} (${item.qty} ${item.unit})</option>`;
            anSelect.innerHTML += `<option value="${item.name}">${item.name}</option>`;
        });
        sellSelect.value = currentSell;
    }

    document.getElementById('form-sell').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading(true);
        const res = await sendData({
            authi: AUTH_CODE, action: 'stock_out',
            name: document.getElementById('sell-name').value,
            qty: document.getElementById('sell-qty').value,
            price: document.getElementById('sell-price').value
        });
        if(!res.error) {
            alert("Sold!");
            document.getElementById('form-sell').reset();
            document.getElementById('sell-thumb-preview').classList.add('hidden');
            switchTab('inventory');
            await loadData();
        }
    });

    // --- 3. ADD STOCK LOGIC ---
    document.getElementById('form-add').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading(true);
        const file = document.getElementById('in-file').files[0];
        const base64 = file ? await resizeImage(file) : "";

        await sendData({
            authi: AUTH_CODE, action: 'stock_in',
            name: document.getElementById('in-name').value,
            unit: document.getElementById('in-unit').value,
            qty: document.getElementById('in-qty').value,
            price: document.getElementById('in-price').value,
            image: base64
        });
        document.getElementById('form-add').reset();
        await loadData();
    });

    // --- 4. HISTORY LOGIC (New Feature) ---
    async function loadHistory() {
        showLoading(true);
        const start = document.getElementById('hist-start').value;
        const end = document.getElementById('hist-end').value;

        const data = await sendData({
            authi: AUTH_CODE,
            action: 'get_transactions',
            start: start,
            end: end
        }, true);

        const tbody = document.getElementById('history-list');
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No transactions found.</td></tr>';
        } else {
            // Sort by date (newest first)
            data.reverse().forEach(row => {
                const dateObj = new Date(row.date);
                const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const badgeClass = row.type === 'IN' ? 'badge-in' : 'badge-out';

                tbody.innerHTML += `
                    <tr>
                        <td class="small text-muted">${dateStr}</td>
                        <td class="fw-bold">${row.item}</td>
                        <td><span class="badge ${badgeClass}">${row.type}</span></td>
                        <td>${row.qty}</td>
                        <td>â‚¹ ${row.price}</td>
                    </tr>`;
            });
        }
        showLoading(false);
    }

    // --- 5. ANALYTICS LOGIC (Updated Header) ---
    async function runAnalytics() {
        showLoading(true);
        updateDateHeader();

        const data = await sendData({
            authi: AUTH_CODE, action: 'analytics',
            start: document.getElementById('an-start').value,
            end: document.getElementById('an-end').value,
            item: document.getElementById('an-item').value
        }, true);

        document.getElementById('res-expense').innerText = "â‚¹ " + (data.acquired || 0).toFixed(2);
        document.getElementById('res-income').innerText = "â‚¹ " + (data.sold || 0).toFixed(2);
        showLoading(false);
    }

    function updateDateHeader() {
        document.getElementById('report-range-start').innerText = document.getElementById('an-start').value;
        document.getElementById('report-range-end').innerText = document.getElementById('an-end').value;
    }

    // --- UTILS ---
    async function sendData(payload) {
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            const data = await res.json();
            if(data.error) alert(data.error);
            return data;
        } catch(e) { alert("Connection Error"); return {error:true}; }
    }

    function fixDriveLink(url) {
        if(url && url.includes('drive.google.com') && !url.includes('thumbnail')) {
             const idMatch = url.match(/id=([a-zA-Z0-9_-]+)/);
             if(idMatch) return `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=s512`;
        }
        return url;
    }

    function updateSellThumbnail() {
        const name = document.getElementById('sell-name').value;
        const imgEl = document.getElementById('sell-thumb-preview');
        const item = INVENTORY_DATA.find(i => i.name === name);
        const imgUrl = item ? fixDriveLink(item.image) : "";

        if (imgUrl) { imgEl.src = imgUrl; imgEl.classList.remove('hidden'); }
        else { imgEl.classList.add('hidden'); }
    }

    function resizeImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 512;
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > MAX) { h *= MAX/w; w = MAX; } }
                    else { if (h > MAX) { w *= MAX/h; h = MAX; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            };
        });
    }

    function showLoading(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
</script>

</body>
</html>
